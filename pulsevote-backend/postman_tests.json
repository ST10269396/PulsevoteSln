{
  "info": {
    "name": "PulseVote RBAC API Tests",
    "description": "Test script for PulseVote RBAC implementation",
    "schema": "https://schema.getpostman.com/json/collection/v2.1.0/collection.json"
  },
  "variable": [
    {
      "key": "baseUrl",
      "value": "http://localhost:5000/api",
      "type": "string"
    },
    {
      "key": "adminEmail",
      "value": "admin@pulsevote.com",
      "type": "string"
    },
    {
      "key": "adminPassword",
      "value": "AdminPass123",
      "type": "string"
    },
    {
      "key": "managerEmail",
      "value": "manager@pulsevote.com",
      "type": "string"
    },
    {
      "key": "managerPassword",
      "value": "ManagerPass123",
      "type": "string"
    },
    {
      "key": "userEmail",
      "value": "user@pulsevote.com",
      "type": "string"
    },
    {
      "key": "userPassword",
      "value": "UserPass123",
      "type": "string"
    },
    {
      "key": "adminToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "managerToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "userToken",
      "value": "",
      "type": "string"
    },
    {
      "key": "organisationId",
      "value": "",
      "type": "string"
    },
    {
      "key": "joinCode",
      "value": "",
      "type": "string"
    },
    {
      "key": "pollId",
      "value": "",
      "type": "string"
    }
  ],
  "item": [
    {
      "name": "1. Register Admin",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{adminEmail}}\",\n  \"password\": \"{{adminPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/register-admin",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "register-admin"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('adminToken', response.token);",
              "    console.log('Admin token saved:', response.token);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "2. Register Manager (by Admin)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{adminToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{managerEmail}}\",\n  \"password\": \"{{managerPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/register-manager",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "register-manager"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('managerToken', response.token);",
              "    console.log('Manager token saved:', response.token);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "3. Register User",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"email\": \"{{userEmail}}\",\n  \"password\": \"{{userPassword}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/auth/register-user",
          "host": ["{{baseUrl}}"],
          "path": ["auth", "register-user"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('userToken', response.token);",
              "    console.log('User token saved:', response.token);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "4. Create Organisation (by Manager)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"name\": \"Test Organisation\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/organisations/create-organisation",
          "host": ["{{baseUrl}}"],
          "path": ["organisations", "create-organisation"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('organisationId', response.organisation._id);",
              "    pm.collectionVariables.set('joinCode', response.organisation.joinCode);",
              "    console.log('Organisation ID saved:', response.organisation._id);",
              "    console.log('Join code saved:', response.organisation.joinCode);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "5. Join Organisation (by User)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{userToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"joinCode\": \"{{joinCode}}\"\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/organisations/join-organisation",
          "host": ["{{baseUrl}}"],
          "path": ["organisations", "join-organisation"]
        }
      }
    },
    {
      "name": "6. Create Poll (by Manager)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"organisationId\": \"{{organisationId}}\",\n  \"question\": \"What is your favorite programming language?\",\n  \"options\": [\"JavaScript\", \"Python\", \"Java\", \"C#\"]\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/polls/create-poll",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "create-poll"]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 201) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('pollId', response.poll._id);",
              "    console.log('Poll ID saved:', response.poll._id);",
              "}"
            ]
          }
        }
      ]
    },
    {
      "name": "7. Vote on Poll (by User)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{userToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"optionIndex\": 0\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/polls/vote/{{pollId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "vote", "{{pollId}}"]
        }
      }
    },
    {
      "name": "8. Get Poll Results",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{userToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/polls/get-poll-results/{{pollId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "get-poll-results", "{{pollId}}"]
        }
      }
    },
    {
      "name": "9. Get Organisation Polls",
      "request": {
        "method": "GET",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/polls/get-polls/{{organisationId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "get-polls", "{{organisationId}}"]
        }
      }
    },
    {
      "name": "10. Close Poll (by Manager)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/polls/close/{{pollId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "close", "{{pollId}}"]
        }
      }
    },
    {
      "name": "11. Try to Vote on Closed Poll (Should Fail)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Content-Type",
            "value": "application/json"
          },
          {
            "key": "Authorization",
            "value": "Bearer {{userToken}}"
          }
        ],
        "body": {
          "mode": "raw",
          "raw": "{\n  \"optionIndex\": 1\n}"
        },
        "url": {
          "raw": "{{baseUrl}}/polls/vote/{{pollId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "vote", "{{pollId}}"]
        }
      }
    },
    {
      "name": "12. Open Poll (by Manager)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/polls/open/{{pollId}}",
          "host": ["{{baseUrl}}"],
          "path": ["polls", "open", "{{pollId}}"]
        }
      }
    },
    {
      "name": "13. Generate New Join Code (by Manager)",
      "request": {
        "method": "POST",
        "header": [
          {
            "key": "Authorization",
            "value": "Bearer {{managerToken}}"
          }
        ],
        "url": {
          "raw": "{{baseUrl}}/organisations/generate-join-code/{{organisationId}}/",
          "host": ["{{baseUrl}}"],
          "path": ["organisations", "generate-join-code", "{{organisationId}}", ""]
        }
      },
      "event": [
        {
          "listen": "test",
          "script": {
            "exec": [
              "if (pm.response.code === 200) {",
              "    const response = pm.response.json();",
              "    pm.collectionVariables.set('joinCode', response.joinCode);",
              "    console.log('New join code saved:', response.joinCode);",
              "}"
            ]
          }
        }
      ]
    }
  ]
}
